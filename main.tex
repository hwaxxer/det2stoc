\documentclass{kththesis}

\usepackage{csquotes} % Recommended by biblatex
\usepackage[style=numeric,sorting=none,backend=biber]{biblatex}
\addbibresource{references.bib} % The file containing our references, in BibTeX format
%\usepackage[T1]{fontenc} needed for black boxes in bibliography?


\usepackage{amsmath,amsthm, amssymb}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}  % for BO-DMIX algo
\usepackage{wrapfig}
\usepackage{amsfonts}
\usepackage{booktabs}
% \usepackage{float}
\usepackage{subcaption}
\usepackage{rotating}
\usepackage{overpic}
\usepackage[outercaption]{sidecap}  


\usepackage{nameref}
% For \ang
\usepackage{siunitx}

\usepackage[font={small}]{caption} % To make image captions smaller
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{mathtools}
% \usepackage{color}
%\usepackage{hyperref}
%\usepackage{verbatim}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,positioning,bayesnet,backgrounds,calc,decorations.pathreplacing}
\usepackage{enumitem}  % for tighter list spacing

% Smaller bullets in lists.
\newlength{\mylen}
% \setbox1=\hbox{$\bullet$}\setbox2=\hbox{\tiny$\bullet$}
% \setlength{\mylen}{\dimexpr0.5\ht1-0.5\ht2} 
% \setlist[itemize]{itemsep=0mm, topsep=2pt}

%======================================================
\newcommand{\vz}{\boldsymbol{z}}
\newcommand{\vx}{\boldsymbol{x}}
\newcommand{\vy}{\boldsymbol{y}}
\newcommand{\vth}{\boldsymbol{\theta}}
\newcommand{\vph}{\boldsymbol{\phi}}
\newcommand{\vpsi}{\vec{\psi}}

\DeclareMathOperator{\E}{\mathbb{E}}
\renewcommand{\vec}[1]{\boldsymbol{#1}}

\makeatletter
\newcommand{\@givennoparenthesis}[2]{\ensuremath{{{#1}\;\middle|\;{#2}}}}
\newcommand{\givennop}{\@givennoparenthesis}
\newcommand{\@giventhatstar}[2]{\ensuremath{\left({#1}\;\middle|\;{#2}\right)}}
\newcommand{\@giventhatnostar}[3][]{#1(#2\,#1|\,#3#1)} 
\newcommand{\given}{\@ifstar\@giventhatstar\@giventhatnostar}
\makeatother
 
\DeclarePairedDelimiterX{\infdivx}[2]{\big(}{\big)}{%
  #1\;\delimsize\|\;#2%
}
\newcommand{\KL}{D_{\mathcal{KL}}\infdivx}
\newcommand{\N}{\mathcal{N}}

\newcommand{\vae}{\textsc{vae}}
\newcommand{\cvae}{\textsc{cvae}}
\newcommand{\dettostoc}{\textsc{det2stoc}}

\newcommand{\vs}{\pmb{s}_t}
\newcommand{\va}{\pmb{a}_t}
\newcommand{\vns}{\pmb{s}_{t+1}}

\newcommand{\fsimulator}{\ensuremath{f^{sim}}}
\newcommand{\fpsisimulator}{\ensuremath{f^{sim}_{\psi}}}
\newcommand{\fdecoder}{\ensuremath{f^{decoder}}}
\newcommand{\fencoder}{\ensuremath{f^{encoder}}}
% \newcommand{\fdecoder}{\ensuremath{f_{\phi_{decoder}}}}

\newcommand{\ra}[1]{\renewcommand{\arraystretch}{#1}}

\newcommand{\pfriction}{\psi_{\textsc{friction}}}
\newcommand{\pcom}{\psi_{\textsc{com}}}
\newcommand{\pwind}{\psi_{\textsc{wind}}}

\newcommand{\ptheta}{p_{\theta}}
\newcommand{\qphi}{q_{\phi}}

\newcommand{\trajsim}{\xi^{sim}}
\newcommand{\trajreal}{\xi^{real}}

% Used when drawing neural nets
\def\layersep{50pt}
\definecolor{rose}{HTML}{ffa9b5}
\definecolor{curry}{HTML}{f6c800}
\definecolor{moss}{HTML}{757b33}

%======================================================

\title{det2stoc -- Converting Deterministic Simulators to Realistic Stochastic Models via Data Alignment}
\alttitle{det2stoc -- Omvandla deterministiska simulatorer till realistiska stokastiska modeller via data alignment.}
\author{Martin Hwasser}
\email{hwasser@kth.se}
\supervisor{Rika Antonova}
\examiner{Danica Kragic}
\programme{Master in Computer Science}
\school{School of Electrical Engineering and Computer Science}
\date{\today}

\kthcover{kth-cover.pdf}

\begin{document}
\frontmatter
\titlepage
% ======================================================
% ABSTRACT
% ======================================================
\begin{abstract}
Simulations are widely used to train agents in Reinforcement Learning since they provide an affluence of data that in many cases can be generated faster than real-time. However, the behaviors learned by the agent will be specific to attributes of the simulator and may not perform well when transfered to the real world. This thesis describes an algorithm that can be used to minimize the discrepancy between simulation and reality. Using this algorithm, it is possible to both identify parameters of the simulator whose true values are unknown, as well as replacing a deterministic simulator with a generative model that can produce output that is close to real-world dynamics.

We first demonstrate this algorithm on a problem that can be solved analytically. We then show that the algorithm can generalize to more elaborate environments with physics simulation involving contact between objects.

%And finally, we show that the algorithm can be used to facilitate training an agent in simulation and transferring the learned policy to a real robot.
\end{abstract}
\begin{otherlanguage}{swedish}
  \begin{abstract}
    \todo[inline]{En abstract p√• svenska.}
  \end{abstract}
\end{otherlanguage}

\section*{Acknowledgements}

\todo[inline]{Thank Rika here :)}

% ======================================================
\tableofcontents
% ======================================================
\mainmatter
% ======================================================

\include{inputs/introduction}

\include{inputs/background}

\include{inputs/method}

\include{inputs/conclusions} 

%======================================================
\printbibliography[heading=bibintoc]

\appendix

\chapter{A}
\label{appendix:a}


\begin{figure}
\centering
\text{Latent space encodings for the Windy Slope scenario.}
\captionsetup{size=footnotesize}
\begin{subfigure}{\linewidth}
  \includegraphics[width=1.0\linewidth]{img/windyslope/latent-representation/new/iter0}
  \caption{Initial estimates of $\psi$}
  \label{fig_3_parameters_0}
\end{subfigure}
\begin{subfigure}{\linewidth}
  \includegraphics[width=1.0\linewidth]{img/windyslope/latent-representation/new/latent_encoding_iter1}
  \caption{1st iteration of \dettostoc{}}
  \label{fig_3_parameters_0}
\end{subfigure}
\begin{subfigure}{\textwidth}
  \includegraphics[width=1.0\linewidth]{img/windyslope/latent-representation/new/latent_encoding_iter2}
  \caption{2nd iteration of \dettostoc{}}
\end{subfigure}
\begin{subfigure}{\textwidth}
  \includegraphics[width=1.0\linewidth]{img/windyslope/latent-representation/new/latent_encoding_iter3}
  \caption{3rd iteration of \dettostoc{}}
\end{subfigure}
\caption{Plots show the learned parameters $\vph_{\mu, \sigma}$ of the posterior given \emph{real} samples $\vec{\xi}^{real}$ as normalized histograms after subsequent steps of \dettostoc{}.
From left-to-right, the latent space codings show tangential friction, center of mass and wind. %The prior parameters $\vpsi$ for each iteration of \dettostoc{} are included for clarity in a lighter color, along with the true distribution $\theta_{\mu, \sigma}$ in black dashes.}
The \emph{real} distribution of the parameters $\theta_{\mu, \sigma}$ in drawn with black dashes.}
\label{fig:windyslope_latent_space_full}
\end{figure}

\begin{figure}
\centering
\text{Latent space encodings for the YuMi scenario.}
\captionsetup{size=footnotesize}
\begin{subfigure}{0.45\textwidth}
  \includegraphics[width=\textwidth]{img/yumi/latent-representation/yumi_latent_encoding_0_iter}%
  \caption{Initial estimates of $\vpsi$ before \dettostoc{}}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
  \centering
  \includegraphics[width=\linewidth]{img/yumi/latent-representation/yumi_latent_encoding_1_iter}
  \caption{$\psi$ after 1st iteration of \dettostoc{}}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
  \centering
  \includegraphics[width=\linewidth]{img/yumi/latent-representation/yumi_latent_encoding_2_iter}
  \caption{$\psi$ after 2nd iteration of \dettostoc{}}
\end{subfigure}
\begin{subfigure}{0.45\textwidth}
  \centering
  \includegraphics[width=\linewidth]{img/yumi/latent-representation/yumi_latent_encoding_3_iter}
  \caption{$\psi$ after 3rd iteration of \dettostoc{}}
\end{subfigure}
\caption{Plots show the learned parameters $\vph_{\mu, \sigma}$ of the posterior given \emph{real} samples $\vec{\xi}^{real}$ in the YuMi scenario for four iteration of \dettostoc{}.
The parameters correspond (from left-to-right) to tangential friction $\pfriction$, center of mass $\pcom$. The true distributions $\vth_{\mu, \sigma}$ are outlined in black dashes. In this scenario, \dettostoc{} struggles to match $\pfriction{}$ with the true distribution $\th_\textsc{friction}$. This is likely due to the fact that the learned policy pushes the box in small increments, and small changes in friction do not cause any noticable difference. The posterior for all iterations can be found in the appendix.}
\label{fig:yumi_latent_space_full}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{img/windyslope/output/windyslope_output_det2stoc2_dist_10_step1_iter4.png}
    \caption{Output predictions $p_{\vph}\protect\given*{\vns}{\vs}$ for a randomly sampled state at $t=1$ for iteration 4 of \dettostoc{}.}
    \label{fig:output_distribution_step1_posvel_dettostoc}
\end{figure}%
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{img/windyslope/output/windyslope_output_det2stoc2_dist_10_step50_iter4.png}
    \caption{Output predictions $p_{\vph}\protect\given*{\vns}{\vs}$ for a randomly sampled state at $t=50$ for iteration 4 of \dettostoc{}.}
    \label{fig:output_distribution_step50_posvel_dettostoc}
\end{figure}
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{img/windyslope/output/windyslope_output_det2stoc2_dist_10_step100_iter4.png}
    \caption{Output predictions $p_{\vph}\protect\given*{\vns}{\vs}$ for a randomly sampled state at $t=100$ for iteration 4 of \dettostoc{}.}
    \label{fig:output_distribution_step100_posvel_dettostoc}
\end{figure}
\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{img/windyslope/output/windyslope_output_baseline_dist_10_step50.png}
    \caption{Output predictions $p_{\vph}\protect\given*{\vns}{\vs}$ for a randomly sampled state at $t=50$ for CVAE (baseline).}
    \label{fig:output_distribution_step50_posvel_baseline}
\end{figure}


%======================================================
\input{inputs/appendix}
%======================================================
\tailmatter
%======================================================

\end{document}